---
import type { MetaData } from '~/types';
import Layout from '../../layouts/Layout.astro';
import ClosingPage from '~/components/prayer/Closing.astro';
const metadata: MetaData = {
  title: 'My Reflection & Prayer',
};
---

<Layout metadata={metadata}>
  <div class="page-container">
    <ClosingPage />
  </div>
</Layout>

<style>
  :global(body) {
    margin: 0;
    padding: 0;
    font-family: 'Jost', sans-serif;
  }
  .page-container {
    max-width: 600px;
    margin: 0 auto;
    font-family:
      'Jost',
      -apple-system,
      BlinkMacSystemFont,
      'Segoe UI',
      Roboto,
      sans-serif;
  }
</style>

<script>
  import dayjs from 'dayjs';
  import relativeTime from 'dayjs/plugin/relativeTime';
  import { openApp } from '~/utils/applink';
  import { decodeShare } from '~/services';
  import type { DevotionalComment } from '~/services';

  dayjs.extend(relativeTime);

  const urlParams = new URLSearchParams(window.location.search);
  const ticket = urlParams.get('ticket');
  let clickHandler: (() => void) | null = null;

  const icons = () =>
    (window as { __CLOSING_ICONS__?: { heart: string; msg: string; steak: string } }).__CLOSING_ICONS__;

  function formatCommentTime(createdAt: string): string {
    return dayjs(createdAt).fromNow();
  }

  function renderComment(comment: DevotionalComment): string {
    const icon = icons();
    const heartSrc = icon?.heart ?? '';
    const msgSrc = icon?.msg ?? '';
    const steakSrc = icon?.steak ?? '';
    const avatar = comment.userAvatar || comment.user?.avatarUrl || '';
    const name = (comment.userName || comment.user?.fullName) ?? 'Unknown';
    const time = formatCommentTime(comment.createdAt);
    const likes = comment.likes ?? 0;
    const replies = comment.repliesCount ?? 0;
    const content = escapeHtml(comment.content);
    const steaks = comment.user?.steaks ?? 0;

    return `
      <div class="comment-item">
        <div class="comment-avatar-container">
          <img src="${escapeAttr(avatar)}" class="comment-avatar" alt="" onerror="this.src=''" />
          <div class="comment-user-container">
            <div class="comment-user-row">
              <span class="comment-name">${escapeHtml(name)}</span>
              <span class="comment-time">${escapeHtml(time)}</span>
            </div>
            <div class="comment-badges-row">
            <div class="comment-replies-container">
              <img src="${escapeAttr(steakSrc)}" alt="steak" class="w-2 h-2" />
              <span class="comment-replies-count">${steaks}</span>
            </div>
            </div>
          </div>
        </div>
        <div class="comment-content">
          <div class="comment-text">${content}</div>
          <div class="comment-actions">
            <div class="action-item">
              <img src="${escapeAttr(heartSrc)}" alt="heart" class="w-[16px] h-[16px]" />
              <span>${likes}</span>
            </div>
            <div class="action-item">
              <img src="${escapeAttr(msgSrc)}" alt="message" class="w-[14px] h-[14px]" />
              <span>${replies}</span>
            </div>
          </div>
        </div>
      </div>`;
  }

  function escapeHtml(s: string): string {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }
  function escapeAttr(s: string): string {
    return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function renderCommentsList(comments: DevotionalComment[]) {
    const headerEl = document.getElementById('commentsHeader');
    const listEl = document.getElementById('commentsList');
    if (!headerEl || !listEl) return;
    headerEl.textContent = `All Comments (${comments.length})`;
    listEl.innerHTML = comments.map((c) => renderComment(c)).join('');
  }

  const fetchData = async () => {
    const data = await decodeShare(ticket as string);

    const avatarElement = document.getElementById('userAvatar') as HTMLImageElement;
    const nameElement = document.getElementById('userName') as HTMLSpanElement;
    const closingBody = document.querySelector('#closingBody') as HTMLDivElement;
    const closingButton = document.querySelector('#closingButton') as HTMLAnchorElement;

    if (avatarElement && data?.shareUser?.avatarUrl) {
      avatarElement.src = data.shareUser.avatarUrl;
    }

    if (nameElement && data?.shareUser?.fullName) {
      nameElement.textContent = data.shareUser.fullName;
    }

    if (closingBody) {
      closingBody.textContent = '';
      if (data?.data?.closing) {
        closingBody.textContent = data.data.closing;
      }
    }

    const comments = data?.data?.comments ?? [];
    renderCommentsList(comments);

    if (closingButton && ticket) {
      clickHandler = () => {
        openApp(`share/devotional?ticket=${ticket}`);
      };
      closingButton.addEventListener('click', clickHandler);
    }
  };

  // 在页面加载和页面切换时都执行更新
  const updateContent = () => {
    if (ticket) {
      fetchData();
    }
  };

  document.addEventListener('astro:page-load', updateContent);
  document.addEventListener('astro:after-swap', updateContent);

  document.addEventListener('astro:before-swap', () => {
    const closingButton = document.querySelector('#closingButton') as HTMLAnchorElement;
    if (closingButton && clickHandler) {
      closingButton.removeEventListener('click', clickHandler);
      clickHandler = null;
    }
  });
</script>
