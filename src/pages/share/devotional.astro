---
import type { MetaData } from '~/types';
import Layout from '../../layouts/Layout.astro';
import ReflectionPage from '~/components/prayer/Reflection.astro';
import { decodeShare, type DevotionalComment } from '~/services';
import dayjs from 'dayjs';

// 标记此页面为 SSR 模式
export const prerender = false;

// 定义分享数据的类型
interface ShareData {
  data?: {
    title?: string;
    reflection?: string;
    verse?: string;
    coverUrl?: string;
    displayDate?: string;
    createdAt?: string;
    verseMarker?: string;
    comments?: DevotionalComment[];
  };
  shareUser?: {
    avatarUrl?: string;
    fullName?: string;
  };
}

// 在服务端获取数据
const ticket = Astro.url.searchParams.get('ticket');
let shareData: ShareData | null = null;
let metadata: MetaData = {
  title: 'My Reflection & Prayer',
};

if (ticket) {
  try {
    shareData = await decodeShare(ticket);
    if (shareData?.data?.title) {
      const formattedDate = shareData.data.displayDate ? dayjs(shareData.data.displayDate).format('MMMD') : '';
      metadata = {
        title: formattedDate ? `${formattedDate} - ${shareData.data.title}` : shareData.data.title,
      };
    }
  } catch (error) {
    console.error('Failed to fetch share data:', error);
  }
}
---

<Layout metadata={metadata}>
  <div class="page-container">
    <ReflectionPage />
  </div>
  <!-- 将服务端数据传递给客户端 -->
  {
    shareData && (
      <script define:vars={{ shareData, ticket }}>
        window.__SHARE_DATA__ = shareData; window.__TICKET__ = ticket;
      </script>
    )
  }
</Layout>

<style>
  :global(body) {
    margin: 0;
    padding: 0;
    font-family: 'Jost', sans-serif;
  }
  .page-container {
    max-width: 600px;
    margin: 0 auto;
    font-family:
      'Jost',
      -apple-system,
      BlinkMacSystemFont,
      'Segoe UI',
      Roboto,
      sans-serif;
  }
  .hidden {
    display: none;
  }
</style>

<script>
  import dayjs from 'dayjs';
  import { decodeShare, type DecodeShareData } from '~/services';

  // 定义分享数据的类型（客户端）
  interface ShareData {
    data?: {
      title?: string;
      reflection?: string;
      verse?: string;
      coverUrl?: string;
      displayDate?: string;
      createdAt?: string;
      verseMarker?: string;
      reflectionContent?: string;
    };
    shareUser?: {
      avatarUrl?: string;
      fullName?: string;
    };
  }

  // 扩展 Window 接口
  interface WindowWithShareData extends Window {
    __SHARE_DATA__?: ShareData;
    __TICKET__?: string;
  }

  // 优先使用服务端传递的数据，如果没有则从 URL 获取 ticket 并请求
  const urlParams = new URLSearchParams(window.location.search);
  const ticketFromUrl = urlParams.get('ticket');
  const serverData = (window as WindowWithShareData).__SHARE_DATA__;
  const serverTicket = (window as WindowWithShareData).__TICKET__;
  const ticket = serverTicket || ticketFromUrl;

  const fetchData = async () => {
    // 优先使用服务端数据（服务端为 ShareData，接口为 DecodeShareData，结构兼容）
    let data: ShareData | DecodeShareData | null | undefined = serverData;

    // 如果没有服务端数据，则从 API 获取
    if (!data && ticket) {
      data = await decodeShare(ticket);
    }

    if (!data) return;

    // 接口与服务端结构一致，统一按 ShareData 使用
    const d = data as ShareData;

    const avatarElement = document.getElementById('userAvatar') as HTMLImageElement;
    const nameElement = document.getElementById('userName') as HTMLSpanElement;
    const reflectionCover = document.querySelector('#reflectionCover') as HTMLImageElement;
    const reflectionDate = document.querySelector('#reflectionDate') as HTMLDivElement;
    const reflectionTitle = document.querySelector('#reflectionTitle') as HTMLHeadingElement;
    const reflectionVerse = document.querySelector('#reflectionVerse') as HTMLDivElement;
    const reflectionVerseText = document.querySelector('#reflectionVerseText') as HTMLDivElement;
    const reflectionVerseMarker = document.querySelector('#reflectionVerseMarker') as HTMLDivElement;
    const reflectionBody = document.querySelector('#reflectionBody') as HTMLDivElement;
    const reflectionButton = document.querySelector('#reflectionButton') as HTMLAnchorElement;

    if (avatarElement && d?.shareUser?.avatarUrl) {
      avatarElement.src = d.shareUser.avatarUrl;
    }

    if (nameElement && d?.shareUser?.fullName) {
      nameElement.textContent = d.shareUser.fullName;
    }

    if (reflectionCover) {
      reflectionCover.src = '';
      if (d?.data?.coverUrl) {
        reflectionCover.src = d.data.coverUrl;
      }
    }

    if (reflectionDate) {
      reflectionDate.textContent = '';

      if (d?.data?.displayDate) {
        reflectionDate.textContent = dayjs(d.data.displayDate).format('MMM D, YYYY');
      } else if (d?.data?.createdAt) {
        reflectionDate.textContent = dayjs(d.data.createdAt).format('MMM D, YYYY');
      }
    }

    if (reflectionTitle) {
      reflectionTitle.textContent = '';
      if (d?.data?.title) {
        reflectionTitle.textContent = d.data.title;
      }
    }

    if (reflectionVerse && reflectionVerseText && reflectionVerseMarker) {
      reflectionVerseText.textContent = '';
      reflectionVerseMarker.textContent = '';
      reflectionVerse.style.display = 'none';
      if (d?.data?.verse) {
        reflectionVerseText.textContent = d.data.verse;
        reflectionVerseMarker.textContent = d.data.verseMarker || '';
        reflectionVerse.style.display = 'block';
      }
    }

    if (reflectionBody) {
      reflectionBody.textContent = '';
      if (d?.data?.reflectionContent) {
        reflectionBody.textContent = d.data.reflectionContent;
      }
    }

    if (reflectionButton && ticket) {
      reflectionButton.setAttribute('href', `/share/prayer?ticket=${ticket || ''}`);
    }
  };

  // 在页面加载和页面切换时都执行更新
  const updateContent = () => {
    if (ticket) {
      fetchData();
    }
  };

  // 立即执行一次（页面首次加载）
  updateContent();

  // 监听 Astro 页面事件
  document.addEventListener('astro:page-load', updateContent);
  document.addEventListener('astro:after-swap', updateContent);
</script>