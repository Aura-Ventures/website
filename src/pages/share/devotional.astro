---
import type { MetaData } from '~/types';
import Layout from '../../layouts/Layout.astro';
import ReflectionPage from '~/components/prayer/Reflection.astro';

const metadata: MetaData = {
  title: 'My Reflection & Prayer',
};
---

<Layout metadata={metadata}>
  <div class='page-container'>
    <ReflectionPage />
  </div>
</Layout>

<style>
  :global(body) {
    margin: 0;
    padding: 0;
    font-family: 'Jost', sans-serif;
  }
  .page-container {
    max-width: 600px;
    margin: 0 auto;
    font-family:
      'Jost',
      -apple-system,
      BlinkMacSystemFont,
      'Segoe UI',
      Roboto,
      sans-serif;
  }
  .hidden {
    display: none;
  }
</style>

<script>
  import dayjs from 'dayjs';
  import { decodeShare } from '~/services';
  import { openApp } from '~/utils/applink';

  const urlParams = new URLSearchParams(window.location.search);
  const ticket = urlParams.get('ticket');
  let clickHandler: (() => void) | null = null;

  const fetchData = async () => {
    const data = await decodeShare(ticket as string);
    console.log(data);

    const avatarElement = document.getElementById('userAvatar') as HTMLImageElement;
    const nameElement = document.getElementById('userName') as HTMLSpanElement;
    const reflectionCover = document.querySelector('#reflectionCover') as HTMLImageElement;
    const reflectionDate = document.querySelector('#reflectionDate') as HTMLDivElement;
    const reflectionTitle = document.querySelector('#reflectionTitle') as HTMLHeadingElement;
    const reflectionVerse = document.querySelector('#reflectionVerse') as HTMLDivElement;
    const reflectionVerseText = document.querySelector('#reflectionVerseText') as HTMLDivElement;
    const reflectionVerseMarker = document.querySelector('#reflectionVerseMarker') as HTMLDivElement;
    const reflectionBody = document.querySelector('#reflectionBody') as HTMLDivElement;
    const reflectionButton = document.querySelector('#reflectionButton') as HTMLAnchorElement;

    if (avatarElement && data?.shareUser?.avatarUrl) {
      avatarElement.src = data.shareUser.avatarUrl;
    }

    if (nameElement && data?.shareUser?.fullName) {
      nameElement.textContent = data.shareUser.fullName;
    }

    if (reflectionCover) {
      reflectionCover.src = '';
      if (data?.data?.coverUrl) {
        reflectionCover.src = data?.data?.coverUrl;
      }
    }

    if (reflectionDate) {
      reflectionDate.textContent = '';

      if (data?.data?.displayDate) {
        reflectionDate.textContent = dayjs(data.data.displayDate).format('MMM D, YYYY');
      } else if (data?.data?.createdAt) {
        reflectionDate.textContent = dayjs(data.data.createdAt).format('MMM D, YYYY');
      }
    }

    if (reflectionTitle) {
      reflectionTitle.textContent = '';
      if (data?.data?.title) {
        reflectionTitle.textContent = data.data.title;
      }
    }

    if (reflectionVerse && reflectionVerseText && reflectionVerseMarker) {
      reflectionVerseText.textContent = '';
      reflectionVerseMarker.textContent = '';
      reflectionVerse.style.display = 'none';
      if (data?.data?.verse) {
        reflectionVerseText.textContent = data.data.verse;
        reflectionVerseMarker.textContent = data.data.verseMarker;
        reflectionVerse.style.display = 'block';
      }
    }

    if (reflectionBody) {
      reflectionBody.textContent = '';
      if (data?.data?.reflection) {
        reflectionBody.textContent = data.data.reflection;
      }
    }

    if (reflectionButton) {
      // 移除之前的事件监听器
      if (clickHandler) {
        reflectionButton.removeEventListener('click', clickHandler);
      }
      // 移除 href 属性，改为点击事件
      reflectionButton.removeAttribute('href');
      clickHandler = () => {
        openApp('');
      };
      reflectionButton.addEventListener('click', clickHandler);
    }
  };

  // 在页面加载和页面切换时都执行更新
  const updateContent = () => {
    if (ticket) {
      fetchData();
    }
  };

  document.addEventListener('astro:page-load', updateContent);
  document.addEventListener('astro:after-swap', updateContent);

  document.addEventListener('astro:before-swap', () => {
    const reflectionButton = document.querySelector('#reflectionButton') as HTMLAnchorElement;
    if (reflectionButton && clickHandler) {
      reflectionButton.removeEventListener('click', clickHandler);
      clickHandler = null;
    }
  });
</script>
